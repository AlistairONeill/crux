= crux-kafka-connect

**EXPERIMENTAL**

This project contains `crux.kafka.connect.CruxSinkConnector` which is
an implementation of `org.apache.kafka.connect.sink.SinkConnector`.

Reads JSON and posts it to a Crux node using `crux-http-client`. Also
outputs it to a file like the example file sink:
https://github.com/apache/kafka/blob/trunk/connect/file/src/main/java/org/apache/kafka/connect/file

See also: https://kafka.apache.org/documentation/#connect

Download Kafka from https://kafka.apache.org/downloads

Building the sink connector:
```
export KAFKA_HOME=...
lein uberjar
cp target/*-standalone.jar $KAFKA_HOME/libs
cp test-resources/*.properties $KAFKA_HOME/config
```

Steps to get running:

Start a local Crux node with embedded Kafka in the REPL:

```
(dev)
(start)
```

Start the Connect worker, which will connect to the embedded Kafka:

```
(cd $KAFKA_HOME; ./bin/connect-standalone.sh config/connect-standalone.properties config/connect-file-source.properties config/local-crux-sink.properties)
```

Beware of the `/tmp/connect.offsets` file when restarting the Kafka cluster from scratch.


Write a line of JSON to `test.txt`:

```
echo '{"crux.db/id": "415c45c9-7cbe-4660-801b-dab9edc60c84", "value": "baz"}' >> test.txt
tail -n1 $KAFKA_HOME/test.sink.txt
```

This should output:
```
[:crux.tx/put {:crux.db/id #crux/id "415c45c9-7cbe-4660-801b-dab9edc60c84", :value "bar"}]
```

Verify the entity was transacted in the REPL:

```
(crux/entity (crux/db node) "415c45c9-7cbe-4660-801b-dab9edc60c84")
;=> {:crux.db/id #crux/id "415c45c9-7cbe-4660-801b-dab9edc60c84", :value "bar"}
```
