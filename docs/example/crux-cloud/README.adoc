= Use Crux with Confluent's cloud Kafka platform in <10m 

Confluent's latest Kafka-as-a-service offering is extremely compelling for small Crux deployment as there are no minimum fees and the pricing structure is very simple. `Monthly cost = Data in + Data out + Data retained` . ...so there is no need to think about brokers or other infrastructure costs. Additionally you only pay for what you use and there are no upfront costs or termination fees. The service is currently available in GCP and AWS.

See Confluent's page for pricing details: https://www.confluent.io/confluent-cloud/

== Setup a Confluent Cloud account 

Follow the short sequence of sign-up steps to create an account: https://www.confluent.io/confluent-cloud/

You will need to provide a valid credit/debit card in order to create an account.

Login to access your environment dashboard.

== Create a cluster in your default environment

You will need to choose a name (e.g. `crux-1`) cloud provider (e.g. `GCP`) and region (e.g. `London`).

image::environment-overview.png

== Create a transaction topic

image::new-tx-topic.png

Choose a name (e.g. `tx-1`) and set the number of partitions to `1` then click "Create with defaults".

In the topic overview screen for the newly created topic, click "Edit settings" then "Switch to expert mode" and set the value of `retention_ms` to `9223372036854775807` (i.e. infinite retention). Click "Save changes"

== Create a document topic

Return to the topic list and repeat the same steps as for the transanction topic, except you are free to use partition numbers larger than `1` (e.g. `6`)

== Create an API key

Under "Data In/Out > Clients" click "Create Kafka Cluster API key & secret" and copy the credentials now embedded in the Java snippet into a `.properties` file in a safe location that is accessible from your Crux REPL.

== Start a Clojure REPL

`crux-kafka` must be provided. For instance, navigate to `crux-dev` and run `lein repl` 

Update and run the following code to connect to your cluster and make a transaction:

[source,clj]
----
(require '[crux.api :as crux])
(import (crux.api ICruxAPI))

(def ^crux.api.ICruxAPI system
  (crux/start-cluster-node {:kv-backend "crux.kv.memdb.MemKv"
                            :doc-partitions 6 ; make this match the topic document topic configuration
                            :tx-topic "tx-1"
                            :doc-topic "doc-1"
                            :bootstrap-servers "" ; make this match the value found in the properties file 
                            :kafka-properties-file "path-to-properties.properties"})) ; set the location of the file

(crux/submit-tx system [[:crux.tx/put {:crux.db/id :my-first-doc :very "cool"}]])

(crux/q (crux/db system) {:find '[e e2] :where '[[e :crux.db/id e2]] :full-results? true})
----
